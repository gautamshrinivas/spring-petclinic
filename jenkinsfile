pipeline {
    agent {label 'spring'}
    parameters { 
        choice(name: 'BRACH_TO_BUILD', choices: ['main', 'VER_1'], description: 'Choose the branch') 
        string(name: 'MAVEN_GOAL', defaultValue: 'package', description: 'To build maven')
    }
    triggers {
        pollSCM ('* * * * *')
    }
    stages {
        stage(vcs) {
            steps {
            mail subject: 'Build Started',
                 body: 'Build Started',
                 to: 'gautamrck76@gmail.com',
                git url: 'https://github.com/gautamshrinivas/spring-petclinic.git',
                branch: "${params.BRACH_TO_BUILD}"
            }
        }
        stage(build) {
            steps {
            sh "mvn ${params.MAVEN_GOAL}"        
            }
        }
        stage ('artifactory') {
             steps {
               rtMavenDeployer (
                    id: "MAVEN_DEPLOYER",
                    serverId: "JFROG_JENKINS",
                    releaseRepo: "jenkins-libs-release-local",
                    snapshotRepo: "jenkins-libs-snapshot-local"
                )
             }

        stage('Exec Maven') {
            steps {
                rtMavenRun(
                tool: 'MVN_DEFAULT',
                pom: 'pom.xml',
                goals: 'clean install',
                deployerId: 'MAVEN_DEPLOYER'
                )
            }
        }
        stage ('Publish build info') {
            steps {
                rtPublishBuildInfo (
                    serverId: "JFROG_JENKINS"
                )
            }

    }
    post {
        always {
            echo 'Job completed'
            mail subject: 'Build Completed',
                 body : 'Build Completed',
                 to: 'gautamrck76@gmail.com'
        }
        failure {
            mail subject: 'Build Failed',
                 body: 'Build Failed',
                 to: 'gautamrck76@gmail.com'
        }
        success {
            junit '**/surefire-reports/*.xml'
        }
    }
        stage('archive results') {
            steps {
                 archive '**/target/*.jar'
            }
        }

}